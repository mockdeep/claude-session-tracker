#!/usr/bin/env bash
set -euo pipefail

STATE_DIR="$HOME/.local/state/claude-sessions"
mkdir -p "$STATE_DIR"

action="${1:-}"

# Read stdin (hook JSON payload)
input=""
if [ ! -t 0 ]; then
  input=$(cat)
fi

# Extract session_id from input JSON
session_id=""
if [ -n "$input" ]; then
  session_id=$(echo "$input" | jq -r '.session_id // empty')
fi

if [ -z "$session_id" ]; then
  exit 0
fi

state_file="$STATE_DIR/${session_id}.json"
timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

find_window_id() {
  if [ -n "${WINDOWID:-}" ]; then
    echo "$WINDOWID"
    return
  fi

  # Find the controlling PTY by walking up the process tree
  local pid=$$
  local pty=""
  while [ "$pid" -gt 1 ]; do
    pty=$(readlink /proc/$pid/fd/0 2>/dev/null || true)
    if [[ "$pty" == /dev/pts/* ]]; then
      break
    fi
    pid=$(awk '{print $4}' /proc/$pid/stat 2>/dev/null || echo 1)
  done

  if [[ "$pty" != /dev/pts/* ]]; then
    echo ""
    return
  fi

  # Briefly set terminal title via the PTY, find the window, then clear it
  local marker="__claude_session_${session_id}__"
  printf '\033]2;%s\007' "$marker" > "$pty" 2>/dev/null
  sleep 0.2
  local wid
  wid=$(xdotool search --name "$marker" 2>/dev/null | head -1 || true)
  # Clear the marker title â€” Claude's status line will overwrite it anyway
  printf '\033]2;\007' > "$pty" 2>/dev/null
  echo "${wid:-}"
}

update_state() {
  local new_status="$1"
  if [ -f "$state_file" ]; then
    local tmp="${state_file}.tmp"
    jq --arg status "$new_status" --arg ts "$timestamp" \
      '.status = $status | .timestamp = $ts' "$state_file" > "$tmp"
    mv "$tmp" "$state_file"
  fi
}

case "$action" in
  session-start)
    cwd=$(echo "$input" | jq -r '.cwd // empty')
    project_name=$(basename "$cwd")
    window_id=$(find_window_id)

    local_tmp="${state_file}.tmp"
    jq -n \
      --arg sid "$session_id" \
      --arg cwd "$cwd" \
      --arg pname "$project_name" \
      --arg wid "$window_id" \
      --arg ts "$timestamp" \
      '{
        session_id: $sid,
        cwd: $cwd,
        project_name: $pname,
        window_id: $wid,
        status: "active",
        timestamp: $ts
      }' > "$local_tmp"
    mv "$local_tmp" "$state_file"
    ;;

  notification-idle)
    update_state "idle"
    ;;

  notification-permission)
    update_state "permission"
    ;;

  prompt-submit)
    update_state "active"
    ;;

  session-end)
    rm -f "$state_file"
    ;;

  focus)
    if [ -f "$state_file" ]; then
      wid=$(jq -r '.window_id // empty' "$state_file")
      if [ -n "$wid" ]; then
        # Convert decimal window ID to hex for wmctrl
        hex_wid=$(printf '0x%08x' "$wid")
        wmctrl -i -a "$hex_wid"
      fi
    fi
    ;;

  *)
    echo "Unknown action: $action" >&2
    exit 1
    ;;
esac
